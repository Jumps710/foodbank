<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>管理ダッシュボード - フードパントリー管理システム v6 (Cache-Cleared)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sidebar {
            min-height: 100vh;
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .sidebar .nav-link {
            color: #495057;
            border-radius: 5px;
            margin: 2px 0;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: #007bff;
            color: white;
        }
        .main-content {
            padding: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .table-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar">
                <div class="position-sticky">
                    <h5 class="text-center mb-4">
                        <i class="bi bi-heart-fill text-danger me-2"></i>
                        管理システム
                    </h5>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-page="dashboard">
                                <i class="bi bi-speedometer2 me-2"></i>ダッシュボード
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="pantries">
                                <i class="bi bi-calendar-event me-2"></i>パントリー管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="reservations">
                                <i class="bi bi-list-check me-2"></i>予約状況
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="users">
                                <i class="bi bi-people me-2"></i>ユーザー管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="logs">
                                <i class="bi bi-file-text me-2"></i>ログ管理
                            </a>
                        </li>
                        <hr>
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">
                                <i class="bi bi-house me-2"></i>メインサイト
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-danger" href="#" onclick="logout()">
                                <i class="bi bi-box-arrow-right me-2"></i>ログアウト
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 main-content">
                <div id="pageContent">
                    <!-- コンテンツがここに動的に読み込まれます -->
                </div>
            </main>
        </div>
    </div>

    <!-- モーダル -->
    <div class="modal fade" id="actionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">タイトル</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- モーダル内容 -->
                </div>
                <div class="modal-footer" id="modalFooter">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/config.js?bust=1752983400000"></script>
    <script src="js/firebase-config-simple.js?bust=1752983400000"></script>
    <script src="js/api-simple.js?v=9"></script>
    <script>
        // ページ管理
        let currentPage = 'dashboard';
        let modalInstance = null;

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            modalInstance = new bootstrap.Modal(document.getElementById('actionModal'));
            
            // Firebase認証状態をチェック
            if (window.firebaseAuthManager) {
                window.firebaseAuthManager.onAuthStateChanged = function(user) {
                    if (user) {
                        // Firebase認証済み - ダッシュボードを表示
                        console.log('Firebase認証済みユーザー:', user.email || user.displayName);
                        loadPage('dashboard');
                        setupNavigation();
                    } else {
                        // 未認証 - ログインフォームを表示
                        showLoginForm();
                    }
                };
                
                // Googleリダイレクト結果をチェック
                setTimeout(async () => {
                    try {
                        const redirectResult = await window.firebaseAuthManager.getRedirectResult();
                        if (redirectResult.success && redirectResult.user) {
                            console.log('Google リダイレクト サインイン成功:', redirectResult.user.email);
                            if (redirectResult.isNewUser) {
                                alert('Googleアカウントで新規登録しました！');
                            } else {
                                alert('Googleアカウントでログインしました！');
                            }
                        }
                    } catch (error) {
                        console.warn('リダイレクト結果確認エラー:', error);
                    }
                    
                    // 認証状態をチェック
                    if (window.firebaseAuthManager.getCurrentUser()) {
                        loadPage('dashboard');
                        setupNavigation();
                    } else {
                        showLoginForm();
                    }
                }, 1000);
            } else {
                showLoginForm();
            }
        });

        // ナビゲーション設定
        function setupNavigation() {
            document.querySelectorAll('.sidebar .nav-link[data-page]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    loadPage(page);
                    
                    // アクティブクラス更新
                    document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // ページ読み込み
        async function loadPage(page) {
            currentPage = page;
            const content = document.getElementById('pageContent');
            content.innerHTML = '<div class="loading"><div class="spinner-border"></div><p>読み込み中...</p></div>';
            
            try {
                switch (page) {
                    case 'dashboard':
                        await loadDashboard();
                        break;
                    case 'pantries':
                        await loadPantries();
                        break;
                    case 'reservations':
                        await loadReservations();
                        break;
                    case 'users':
                        await loadUsers();
                        break;
                    case 'logs':
                        await loadLogs();
                        break;
                    default:
                        content.innerHTML = '<div class="alert alert-danger">ページが見つかりません</div>';
                }
            } catch (error) {
                content.innerHTML = '<div class="alert alert-danger">データの読み込みに失敗しました: ' + handleApiError(error) + '</div>';
            }
        }

        // ダッシュボード読み込み
        async function loadDashboard() {
            const stats = await publicApi.getStatistics();
            const pantries = await adminApi.getPantries();
            
            const content = `
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">ダッシュボード</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadPage('dashboard')">
                                <i class="bi bi-arrow-clockwise"></i> 更新
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">${stats.success ? stats.data.totalUsers || 0 : 0}</div>
                            <div>総利用者数</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">${stats.success ? stats.data.totalReservations || 0 : 0}</div>
                            <div>総予約数</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">${pantries.success ? pantries.data.filter(p => p.status === 'active').length : 0}</div>
                            <div>アクティブイベント</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">${pantries.success ? pantries.data.length : 0}</div>
                            <div>総イベント数</div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="table-container">
                            <h5>最近のイベント</h5>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>日時</th>
                                            <th>場所</th>
                                            <th>ステータス</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${pantries.success ? pantries.data.slice(0, 5).map(p => `
                                            <tr>
                                                <td>${formatDate(p.event_date)}</td>
                                                <td>${p.location}</td>
                                                <td><span class="badge bg-${getStatusColor(p.status)}">${getStatusText(p.status)}</span></td>
                                            </tr>
                                        `).join('') : '<tr><td colspan="3">データなし</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="table-container">
                            <h5>システム情報</h5>
                            <ul class="list-unstyled">
                                <li><strong>最終更新:</strong> ${new Date().toLocaleString('ja-JP')}</li>
                                <li><strong>システムバージョン:</strong> v2.0</li>
                                <li><strong>データベース:</strong> Google Sheets</li>
                                <li><strong>ホスティング:</strong> GitHub Pages</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('pageContent').innerHTML = content;
        }

        // パントリー管理読み込み
        async function loadPantries() {
            const pantries = await adminApi.getPantries();
            
            const content = `
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">パントリー管理</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-primary" onclick="showCreatePantryForm()">
                                <i class="bi bi-plus"></i> 新規作成
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="loadPage('pantries')">
                                <i class="bi bi-arrow-clockwise"></i> 更新
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>イベントID</th>
                                    <th>開催日時</th>
                                    <th>場所</th>
                                    <th>定員</th>
                                    <th>予約数</th>
                                    <th>ステータス</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pantries.success ? pantries.data.map(p => `
                                    <tr>
                                        <td>${p.pantry_id}</td>
                                        <td>${formatDate(p.event_date)} ${p.event_time || ''}</td>
                                        <td>${p.location}</td>
                                        <td>${p.capacity_total || 0}</td>
                                        <td>${p.reservation_count || 0}</td>
                                        <td><span class="badge bg-${getStatusColor(p.status)}">${getStatusText(p.status)}</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" onclick="editPantry('${p.pantry_id}')">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deletePantry('${p.pantry_id}')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('') : '<tr><td colspan="7">データがありません</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('pageContent').innerHTML = content;
        }

        // 予約状況読み込み
        async function loadReservations() {
            const reservations = await adminApi.getReservations();
            
            const content = `
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">予約状況</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-outline-secondary" onclick="loadPage('reservations')">
                                <i class="bi bi-arrow-clockwise"></i> 更新
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>予約ID</th>
                                    <th>氏名</th>
                                    <th>イベント</th>
                                    <th>予約日時</th>
                                    <th>ステータス</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reservations.success ? reservations.data.map(r => `
                                    <tr>
                                        <td>${r.reservation_id}</td>
                                        <td>${r.name_kana}</td>
                                        <td>${r.pantry_id}</td>
                                        <td>${formatDateTime(r.created_at)}</td>
                                        <td><span class="badge bg-${getStatusColor(r.status)}">${getStatusText(r.status)}</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info" onclick="viewReservation('${r.reservation_id}')">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="cancelReservation('${r.reservation_id}')">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('') : '<tr><td colspan="6">データがありません</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('pageContent').innerHTML = content;
        }

        // ユーザー管理読み込み
        async function loadUsers() {
            const users = await adminApi.getUsers();
            
            const content = `
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">ユーザー管理</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-outline-secondary" onclick="loadPage('users')">
                                <i class="bi bi-arrow-clockwise"></i> 更新
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>氏名</th>
                                    <th>地域</th>
                                    <th>世帯人数</th>
                                    <th>利用回数</th>
                                    <th>最終利用日</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.success ? users.data.map(u => `
                                    <tr>
                                        <td>${u.name_kana}</td>
                                        <td>${u.area || '-'}</td>
                                        <td>${(u.household_adults || 0) + (u.household_children || 0)}人</td>
                                        <td>${u.total_visits || 0}回</td>
                                        <td>${formatDate(u.last_visit_date) || '-'}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info" onclick="viewUser('${u.user_id}')">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('') : '<tr><td colspan="6">データがありません</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('pageContent').innerHTML = content;
        }

        // ログ管理読み込み
        async function loadLogs() {
            const logs = await adminApi.getLogs();
            
            const content = `
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">ログ管理</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-outline-primary" onclick="exportLogs()">
                                <i class="bi bi-download"></i> エクスポート
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="loadPage('logs')">
                                <i class="bi bi-arrow-clockwise"></i> 更新
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>日時</th>
                                    <th>イベントタイプ</th>
                                    <th>ユーザー</th>
                                    <th>詳細</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${logs.success ? logs.data.map(l => `
                                    <tr>
                                        <td>${formatDateTime(l.created_at)}</td>
                                        <td><span class="badge bg-secondary">${l.event_type}</span></td>
                                        <td>${l.user_name_kana || '-'}</td>
                                        <td>${l.event_detail}</td>
                                    </tr>
                                `).join('') : '<tr><td colspan="4">データがありません</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('pageContent').innerHTML = content;
        }

        // ログイン画面表示
        function showLoginForm() {
            const content = `
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header text-center">
                                <h4 id="authTitle">管理者ログイン</h4>
                                <div class="btn-group w-100 mt-2" role="group">
                                    <button type="button" class="btn btn-outline-primary active" onclick="showLogin()">ログイン</button>
                                    <button type="button" class="btn btn-outline-primary" onclick="showRegister()">新規作成</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <form id="authForm">
                                    <div class="mb-3">
                                        <label class="form-label">メールアドレス</label>
                                        <input type="email" class="form-control" name="email" required placeholder="admin@foodbank.local">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">パスワード</label>
                                        <input type="password" class="form-control" name="password" required>
                                    </div>
                                    <div class="mb-3" id="confirmPasswordGroup" style="display: none;">
                                        <label class="form-label">パスワード確認</label>
                                        <input type="password" class="form-control" name="confirmPassword">
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary" id="authButton">ログイン</button>
                                    </div>
                                    <div class="mt-3">
                                        <div class="text-center">
                                            <span class="text-muted">または</span>
                                        </div>
                                        <div class="d-grid mt-2">
                                            <button type="button" class="btn btn-outline-danger" onclick="signInWithGoogle()">
                                                <i class="bi bi-google me-2"></i>Googleでサインイン
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <small class="text-muted" id="authHelp">
                                            Firebase Authenticationを使用します。<br>
                                            既存の管理者アカウントでログインしてください。
                                        </small>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('pageContent').innerHTML = content;
            
            // フォーム送信イベント
            document.getElementById('authForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const credentials = Object.fromEntries(formData.entries());
                const isRegister = document.getElementById('authButton').textContent === 'アカウント作成';
                
                // パスワード確認チェック（新規作成時）
                if (isRegister && credentials.password !== credentials.confirmPassword) {
                    alert('パスワードが一致しません');
                    return;
                }
                
                try {
                    // Firebase設定が読み込まれるまで待機
                    if (!window.firebaseAuthManager) {
                        alert('Firebase認証システムが読み込まれていません。ページを再読み込みしてください。');
                        return;
                    }
                    
                    if (isRegister) {
                        // アカウント作成
                        const authResult = await window.firebaseAuthManager.createUserWithEmailAndPassword(
                            credentials.email, 
                            credentials.password
                        );
                        
                        if (authResult.success) {
                            alert('アカウントが作成されました！ログインします...');
                            location.reload();
                        } else {
                            alert('アカウント作成に失敗しました: ' + authResult.error.message);
                        }
                    } else {
                        // ログイン
                        const authResult = await window.firebaseAuthManager.signInWithEmailAndPassword(
                            credentials.email, 
                            credentials.password
                        );
                        
                        if (authResult.success) {
                            alert('ログインしました！');
                            location.reload();
                        } else {
                            alert('ログインに失敗しました: ' + authResult.error.message);
                        }
                    }
                } catch (error) {
                    console.error('認証エラー:', error);
                    alert('エラー: ' + (error.message || handleApiError(error)));
                }
            });
        }

        // ログインモードに切り替え
        function showLogin() {
            document.getElementById('authTitle').textContent = '管理者ログイン';
            document.getElementById('authButton').textContent = 'ログイン';
            document.getElementById('confirmPasswordGroup').style.display = 'none';
            document.getElementById('authHelp').innerHTML = 
                'Firebase Authenticationを使用します。<br>既存の管理者アカウントでログインしてください。';
            
            // ボタンのactive状態を更新
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // 新規作成モードに切り替え
        function showRegister() {
            document.getElementById('authTitle').textContent = '管理者アカウント作成';
            document.getElementById('authButton').textContent = 'アカウント作成';
            document.getElementById('confirmPasswordGroup').style.display = 'block';
            document.getElementById('authHelp').innerHTML = 
                '新しい管理者アカウントを作成します。<br>パスワードは6文字以上で設定してください。';
            
            // ボタンのactive状態を更新
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // ユーティリティ関数
        function getStatusColor(status) {
            const colors = {
                'active': 'success',
                'upcoming': 'warning',
                'closed': 'secondary',
                'completed': 'info',
                'cancelled': 'danger'
            };
            return colors[status] || 'secondary';
        }

        function getStatusText(status) {
            const texts = {
                'active': 'アクティブ',
                'upcoming': '予定',
                'closed': '終了',
                'completed': '完了',
                'cancelled': 'キャンセル'
            };
            return texts[status] || status;
        }

        // ログアウト
        async function logout() {
            if (confirm('ログアウトしますか？')) {
                if (window.firebaseAuthManager) {
                    await window.firebaseAuthManager.signOut();
                }
                showLoginForm();
            }
        }

        // Googleサインイン
        async function signInWithGoogle() {
            try {
                if (!window.firebaseAuthManager) {
                    alert('Firebase認証システムが読み込まれていません。ページを再読み込みしてください。');
                    return;
                }

                console.log('Google サインインを開始...');
                const result = await window.firebaseAuthManager.signInWithGoogle();
                
                if (result.success) {
                    if (result.redirect) {
                        // リダイレクト方式の場合
                        console.log(result.message);
                    } else {
                        // ポップアップ方式の場合
                        if (result.isNewUser) {
                            alert('Googleアカウントで新規登録しました！');
                        } else {
                            alert('Googleアカウントでログインしました！');
                        }
                        location.reload();
                    }
                } else {
                    alert('Googleサインインに失敗しました: ' + result.error.message);
                }
            } catch (error) {
                console.error('Google サインインエラー:', error);
                alert('エラー: ' + error.message);
            }
        }

        // パントリー作成フォーム表示
        function showCreatePantryForm() {
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalFooter = document.getElementById('modalFooter');
            
            modalTitle.textContent = 'パントリー作成';
            modalBody.innerHTML = `
                <form id="pantryForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">開催日時 <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" name="event_date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">開催場所 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="location" required placeholder="例: 市川市役所本庁舎">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">予約開始日時 <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" name="reservation_start" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">予約終了日時 <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" name="reservation_end" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">予約上限数 <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="capacity_total" required min="1" max="200" value="50">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">ステータス</label>
                                <select class="form-select" name="status">
                                    <option value="upcoming">予定</option>
                                    <option value="active">受付中</option>
                                    <option value="closed">終了</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">タイトル</label>
                        <input type="text" class="form-control" name="title" placeholder="例: 1月度 フードパントリー">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ヘッダー案内文</label>
                        <textarea class="form-control" name="header_message" rows="3" placeholder="予約フォーム上部に表示される案内文"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">自動応答メール案内文</label>
                        <textarea class="form-control" name="email_message" rows="3" placeholder="予約完了時に送信されるメール本文"></textarea>
                    </div>
                </form>
            `;
            
            modalFooter.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="savePantry()">作成</button>
            `;
            
            modalInstance.show();
        }

        // パントリー保存
        async function savePantry() {
            try {
                const form = document.getElementById('pantryForm');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                // バリデーション
                if (!data.event_date || !data.location || !data.reservation_start || !data.reservation_end || !data.capacity_total) {
                    alert('必須項目を入力してください');
                    return;
                }
                
                const result = await adminApi.createPantry(data);
                
                if (result.success) {
                    alert('パントリーを作成しました');
                    modalInstance.hide();
                    loadPage('pantries'); // 一覧を再読み込み
                } else {
                    alert('作成に失敗しました: ' + (result.error || '不明なエラー'));
                }
            } catch (error) {
                alert('エラー: ' + handleApiError(error));
            }
        }

        // パントリー編集
        async function editPantry(pantryId) {
            try {
                // まず現在のデータを取得
                const pantries = await adminApi.getPantries();
                const pantry = pantries.success ? pantries.data.find(p => p.pantry_id === pantryId) : null;
                
                if (!pantry) {
                    alert('パントリー情報が見つかりません');
                    return;
                }
                
                const modalTitle = document.getElementById('modalTitle');
                const modalBody = document.getElementById('modalBody');
                const modalFooter = document.getElementById('modalFooter');
                
                modalTitle.textContent = 'パントリー編集';
                modalBody.innerHTML = `
                    <form id="pantryEditForm">
                        <input type="hidden" name="pantry_id" value="${pantryId}">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">開催日時 <span class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control" name="event_date" required value="${pantry.event_date || ''}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">開催場所 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="location" required value="${pantry.location || ''}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">予約上限数 <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" name="capacity_total" required min="1" max="200" value="${pantry.capacity_total || 50}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">ステータス</label>
                                    <select class="form-select" name="status">
                                        <option value="upcoming" ${pantry.status === 'upcoming' ? 'selected' : ''}>予定</option>
                                        <option value="active" ${pantry.status === 'active' ? 'selected' : ''}>受付中</option>
                                        <option value="closed" ${pantry.status === 'closed' ? 'selected' : ''}>終了</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                `;
                
                modalFooter.innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" onclick="updatePantry()">更新</button>
                `;
                
                modalInstance.show();
            } catch (error) {
                alert('エラー: ' + handleApiError(error));
            }
        }

        // パントリー更新
        async function updatePantry() {
            try {
                const form = document.getElementById('pantryEditForm');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                const result = await adminApi.updatePantry(data);
                
                if (result.success) {
                    alert('パントリーを更新しました');
                    modalInstance.hide();
                    loadPage('pantries');
                } else {
                    alert('更新に失敗しました: ' + (result.error || '不明なエラー'));
                }
            } catch (error) {
                alert('エラー: ' + handleApiError(error));
            }
        }

        // パントリー削除
        async function deletePantry(pantryId) {
            if (!confirm('このパントリーを削除しますか？\n※関連する予約データも削除されます。')) {
                return;
            }
            
            try {
                const result = await adminApi.deletePantry(pantryId);
                
                if (result.success) {
                    alert('パントリーを削除しました');
                    loadPage('pantries');
                } else {
                    alert('削除に失敗しました: ' + (result.error || '不明なエラー'));
                }
            } catch (error) {
                alert('エラー: ' + handleApiError(error));
            }
        }

        // 予約詳細表示
        async function viewReservation(reservationId) {
            try {
                const result = await adminApi.getReservationDetail(reservationId);
                
                if (result.success) {
                    const reservation = result.data;
                    const modalTitle = document.getElementById('modalTitle');
                    const modalBody = document.getElementById('modalBody');
                    const modalFooter = document.getElementById('modalFooter');
                    
                    modalTitle.textContent = '予約詳細';
                    modalBody.innerHTML = `
                        <table class="table">
                            <tr><th>予約ID</th><td>${reservation.reservation_id || ''}</td></tr>
                            <tr><th>氏名（カナ）</th><td>${reservation.name_kana || ''}</td></tr>
                            <tr><th>パントリー</th><td>${reservation.pantry_id || ''}</td></tr>
                            <tr><th>予約日時</th><td>${formatDateTime(reservation.created_at)}</td></tr>
                            <tr><th>ステータス</th><td><span class="badge bg-${getStatusColor(reservation.status)}">${getStatusText(reservation.status)}</span></td></tr>
                            <tr><th>電話番号</th><td>${reservation.phone || '-'}</td></tr>
                            <tr><th>メールアドレス</th><td>${reservation.email || '-'}</td></tr>
                            <tr><th>世帯人数</th><td>${reservation.household_total || '-'}人</td></tr>
                        </table>
                    `;
                    
                    modalFooter.innerHTML = `
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                        <button type="button" class="btn btn-danger" onclick="cancelReservation('${reservationId}')">予約キャンセル</button>
                    `;
                    
                    modalInstance.show();
                } else {
                    alert('予約情報の取得に失敗しました: ' + (result.error || '不明なエラー'));
                }
            } catch (error) {
                alert('エラー: ' + handleApiError(error));
            }
        }

        // 予約キャンセル
        async function cancelReservation(reservationId) {
            if (!confirm('この予約をキャンセルしますか？')) {
                return;
            }
            
            try {
                const result = await adminApi.cancelReservation(reservationId);
                
                if (result.success) {
                    alert('予約をキャンセルしました');
                    modalInstance.hide();
                    loadPage('reservations');
                } else {
                    alert('キャンセルに失敗しました: ' + (result.error || '不明なエラー'));
                }
            } catch (error) {
                alert('エラー: ' + handleApiError(error));
            }
        }

        // ユーザー詳細表示
        async function viewUser(userId) {
            try {
                const result = await adminApi.getUserDetail(userId);
                
                if (result.success) {
                    const user = result.data;
                    const modalTitle = document.getElementById('modalTitle');
                    const modalBody = document.getElementById('modalBody');
                    const modalFooter = document.getElementById('modalFooter');
                    
                    modalTitle.textContent = 'ユーザー詳細';
                    modalBody.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table">
                                    <tr><th>氏名（カナ）</th><td>${user.name_kana || ''}</td></tr>
                                    <tr><th>地域</th><td>${user.area || '-'}</td></tr>
                                    <tr><th>世帯人数</th><td>${(user.household_adults || 0) + (user.household_children || 0)}人</td></tr>
                                    <tr><th>利用回数</th><td>${user.total_visits || 0}回</td></tr>
                                    <tr><th>最終利用日</th><td>${formatDate(user.last_visit_date) || '-'}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6>利用履歴</h6>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    ${user.visit_history && user.visit_history.length > 0 ? 
                                        user.visit_history.map(visit => `
                                            <div class="border-bottom py-1">
                                                <small>${formatDate(visit.date)} - ${visit.pantry_id}</small>
                                            </div>
                                        `).join('') :
                                        '<small class="text-muted">利用履歴がありません</small>'
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                    
                    modalFooter.innerHTML = `
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                    `;
                    
                    modalInstance.show();
                } else {
                    alert('ユーザー情報の取得に失敗しました: ' + (result.error || '不明なエラー'));
                }
            } catch (error) {
                alert('エラー: ' + handleApiError(error));
            }
        }

        // ログエクスポート
        async function exportLogs() {
            try {
                const result = await adminApi.exportLogs();
                
                if (result.success && result.data) {
                    // CSV データをBlob として作成
                    const blob = new Blob([result.data], { type: 'text/csv;charset=utf-8;' });
                    
                    // ダウンロードリンクを作成
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `foodbank-logs-${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    alert('ログファイルをダウンロードしました');
                } else {
                    alert('ログのエクスポートに失敗しました: ' + (result.error || '不明なエラー'));
                }
            } catch (error) {
                alert('エラー: ' + handleApiError(error));
            }
        }
    </script>
</body>
</html>