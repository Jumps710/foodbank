# 本番環境デプロイ手順

## 🚀 本番環境への緊急デプロイ

既存データがコピーされた新しいスプレッドシートで管理画面を動作させるための手順です。

### 📋 前提条件
- 新しいスプレッドシート: `1XyNivqVU8J6pyF9CA5XNmkv40rAedsnKGdRAn3qniAU`
- 既存データが新しいスプレッドシートにコピー済み
- GitHubリポジトリ: `https://github.com/Jumps710/foodbank`

### 🔧 準備作業

#### 1. 環境確認
```bash
# Node.js とnpmの確認
node --version
npm --version

# 必要に応じてインストール
npm install
```

#### 2. Claspの設定
```bash
# Claspのインストール（未インストールの場合）
npm install -g @google/clasp

# Googleアカウントでログイン
npx clasp login
```

### 🚀 デプロイ実行

#### 方法1: 自動デプロイスクリプト（推奨）
```bash
# デプロイスクリプトを実行
./deploy.sh
```

#### 方法2: 手動デプロイ
```bash
# 1. gas-projectディレクトリに移動
cd gas-project

# 2. 新しいGASプロジェクトを作成
npx clasp create --title "フードパントリー管理システム_v2" --type webapp

# 3. 作成されたスクリプトIDを.clasp.jsonに反映
# （自動的に設定されます）

# 4. ファイルをアップロード
npx clasp push

# 5. Webアプリとしてデプロイ
npx clasp deploy

# 6. プロジェクトを開く
npx clasp open
```

### 📊 データ移行（必要に応じて）

既存データの形式を新システムに合わせて変換する場合：

```bash
# Google Apps Scriptエディタで以下を実行
# 1. data-migration-helper.js の内容をコピー&ペースト
# 2. runDataMigration() を実行
```

### 🔍 動作確認

#### 1. 管理画面の確認
- デプロイされたWebアプリのURLにアクセス
- `?page=admin-dashboard` で管理ダッシュボードを確認
- `?page=admin-pantries` でパントリー管理画面を確認

#### 2. データ表示の確認
- 既存データが正しく表示されるか確認
- 各種統計情報が正しく計算されるか確認

#### 3. 予約フォームの確認
- 予約フォームが正しく動作するか確認
- 新しい予約が正しく保存されるか確認

### 🛡️ セキュリティ設定

#### 1. Web App設定
- **実行ユーザー**: 自分
- **アクセス権限**: 組織内のユーザー（推奨）または全員

#### 2. スプレッドシート権限
- 必要最小限のユーザーのみに編集権限を付与
- 閲覧専用ユーザーを適切に設定

### 🚨 緊急時の対応

#### 問題が発生した場合
1. **既存システムへの復帰**
   - 既存システムは影響を受けていないため即座に利用可能
   - 新システムのWebアプリを無効化

2. **バックアップからの復元**
   - `backup/` フォルダから最新のバックアップを使用
   - 必要に応じてスプレッドシートを復元

3. **ログの確認**
   ```bash
   npx clasp logs
   ```

### 📈 運用開始後の作業

#### 1. 監視設定
- エラーログの定期確認
- 予約数の監視
- システムパフォーマンスの確認

#### 2. ユーザー案内
- 新しい予約システムのURL案内
- 操作方法の説明
- 問い合わせ先の周知

#### 3. 移行スケジュール
- 既存システムとの並行運用期間の設定
- 完全移行のタイミング決定
- 既存システムの段階的停止

### 🔧 トラブルシューティング

#### よくある問題

1. **Claspのログインエラー**
   ```bash
   npx clasp logout
   npx clasp login
   ```

2. **スプレッドシートアクセスエラー**
   - スプレッドシートIDが正しいか確認
   - アクセス権限を確認

3. **デプロイエラー**
   - Google Apps Script APIが有効か確認
   - プロジェクトの設定を確認

#### エラーログの確認方法
```bash
# GAS実行トランスクリプトの確認
npx clasp logs

# 特定の期間のログを確認
npx clasp logs --simplified
```

### 📞 サポート

問題が発生した場合：
1. このドキュメントのトラブルシューティング参照
2. GitHub Issues で問題を報告
3. 緊急時は既存システムを使用して継続運用

### 🎯 成功確認チェックリスト

- [ ] GASプロジェクトの作成完了
- [ ] 全ファイルのアップロード完了
- [ ] Webアプリのデプロイ完了
- [ ] 管理画面へのアクセス確認
- [ ] 既存データの表示確認
- [ ] 予約フォームの動作確認
- [ ] メール通知の動作確認
- [ ] エラーログの確認
- [ ] バックアップの保存確認

---

**🌟 本番環境での安全な運用を目指します！**